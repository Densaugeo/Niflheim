<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

<title>Niflheim</title>

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/lib/PanelUI/PanelUI_light.css" id="light_colors">
<link rel="stylesheet" href="/lib/PanelUI/PanelUI_dark.css" id="dark_colors">
<link rel="stylesheet" href="/lib/PanelUI/PanelUI.css">

<style type='text/css'>
.panel {
  position: relative;
  top: 150px;
  left: calc(50% - 132px);
  width: 300px;
  margin-bottom: 12px;
}

#help {
  position: absolute;
  top: 12px;
  left: 60px;
}
</style>

<script type="text/javascript">
// Frame buster
if(top !== self) {
  top.location.replace(self.location.href);
}
</script>

<script type="text/javascript" src="/lib/draggabilly.pkgd.min.js"></script>
<script type="text/javascript" src="/lib/DF.js"></script>
<script type="text/javascript" src="/lib/PanelUI/PanelUI.js"></script>

<script type="text/javascript" src="/Particles.js"></script>
<script type="text/javascript" src="/lib/Hermes.js"></script>
<script type="text/javascript" src="/lib/PersistentWS.js"></script>
</head>

<body>

<div id="background"></div>

</body>

<script type="text/javascript">
///////////////
// Utilities //
///////////////

// Daisy-chainable HTMLElement maker
var fE = PanelUI.forgeElement;

// Shim for vendor-prefixed fullscreen API
if(HTMLElement.prototype.requestFullscreen == undefined) {
  HTMLElement.prototype.requestFullscreen = HTMLElement.prototype.msRequestFullscreen || HTMLElement.prototype.mozRequestFullScreen || HTMLElement.prototype.webkitRequestFullscreen;
}
if(document.exitFullscreen == undefined) {
  document.exitFullscreen = document.msExitFullscreen || document.mozCancelFullScreen || document.webkitExitFullscreen;
}
if(document.fullscreenElement === undefined) {
  Object.defineProperty(document, 'fullscreenElement', {
    get: function() {
      return document.msFullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement;
    },
  });
}

///////////////
// Instances //
///////////////

var canvas = fE('canvas', {width: 8*32 + 4, height: 12*32 + 4});
var ctx = canvas.getContext('2d');
ctx.fillStyle = '#C0C0C0';
ctx.fillRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = '#000000';
ctx.fillRect(1, 1, canvas.width - 2, canvas.height - 2);

var sidebar = new PanelUI.Sidebar();
sidebar.addButton({buttonName: 'land'    , faClass: 'fa-university', title: 'Landing page'       });
sidebar.addButton({buttonName: 'help'    , faClass: 'fa-question'  , title: 'Help'               });
sidebar.addButton({buttonName: 'fs'      , faClass: 'fa-arrows-alt', title: 'Fullscreen'         });
sidebar.addButton({buttonName: 'contrast', faClass: 'fa-adjust'    , title: 'Flip Contrast'      });
sidebar.addButton({buttonName: 'clear'   , faClass: 'fa-recycle'   , title: 'Clear local storage'});

var viewPanel = new PanelUI.Panel({id: 'viewer', heading: 'First look into Nifleim\'s world'});
viewPanel.domElement.appendChild(canvas);
viewPanel.open();

var helpPanel = new PanelUI.Panel({id: 'help', heading: 'A Panel That Could Be Helpful'});
helpPanel.domElement.appendChild(fE('div', {textContent: 'But this is only a demo'}));

var darkColors = document.getElementById('dark_colors');

////////////
// Events //
////////////

sidebar.on('land', function(e) {
  window.location = '/';
});

sidebar.on('help', function(e) {
  helpPanel.toggleOpen(true);
});

sidebar.on('fs', function(e) {
  if(document.fullscreenElement == null) {
    document.body.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
});

sidebar.on('contrast', function(e) {
  if(darkColors.parentNode === document.head) {
    document.head.removeChild(darkColors);
    localStorage.contrast = 'light';
  } else {
    document.head.appendChild(darkColors);
    localStorage.contrast = 'dark';
  }
});

sidebar.on('clear', function(e) {
  localStorage.clear();
});

////////////////////
// Initialization //
////////////////////

if(localStorage.contrast === 'light') {
  document.head.removeChild(darkColors);
}

///////////////
// WebSocket //
///////////////

Uint8Array.prototype.readUInt32LE = function(offset) {
  return 0x1000000*this[offset + 3] + 0x10000*this[offset + 2] + 0x100*this[offset + 1] + this[offset];
}

Uint8Array.prototype.readUInt16LE = function(offset) {
  return 0x100*this[offset + 1] + this[offset];
}

var regionProperties = {
  width: 0,
  height: 0,
  cellMessageLength: 0,
}

var cache = {};
cache.agents = [];
cache.agentsInitialized = false;
cache.region = [];
cache.regionInitialized = false;
for(var i = 0, endi = 32; i < endi; ++i) {
  cache.region[i] = [];
}

var drawCell = function(x, y, cell) {
  var graphic = cell.agentID === undefined ? cell : cache.agents[cell.agentID];
  
  ctx.hermesRedraw(graphic.char, 2 + 8*x, 2 + 12*y, 1, graphic.color);
}

var drawRegion = function() {
  cache.region.forEach(function(v, i) {
    v.forEach(function(w, j) {
      drawCell(i, j, w);
    });
  });
}

var wsMessageHandler = function(e) {
  if(e.data.constructor.name === 'Blob') {
    var fileReader = new FileReader();
    
    fileReader.onload = function(e) {
      var bytes = new Uint8Array(fileReader.result);
      
      switch(bytes[0]) {
        case 0: // Agent cache
          var numOfAgents = (bytes.length - 1)/8;
          for(var i = 0; i < numOfAgents; ++i) {
            var species = Particles.speciesLibrary[bytes.readUInt32LE(1 + 8*i)];
            
            var red   = ((species.color & 0xFF000000) >>> 0)/0x1000000;
            var green = ((species.color & 0x00FF0000) >>> 0)/0x10000;
            var blue  = ((species.color & 0x0000FF00) >>> 0)/0x100;
            var alpha = ((species.color & 0x000000FF) >>> 0)/0x1;
            
            cache.agents[i] = {
              char: species.char,
              color: 'rgba(' + red + ',' + green + ',' + blue + ',' + alpha + ')'
            }
          }
          
          cache.agentsInitialized = true;
          
          if(cache.regionInitialized) {
            drawRegion();
          }
          
          break;
        case 1: // Region cache
          var numOfCells = (bytes.length - 1)/13;
          for(var i = 0; i < numOfCells; ++i) {
            var terrain = Particles.terrainLibrary[bytes.readUInt32LE(1 + 13*i + 4)];
            
            var red   = ((terrain.color & 0xFF000000) >>> 0)/0x1000000;
            var green = ((terrain.color & 0x00FF0000) >>> 0)/0x10000;
            var blue  = ((terrain.color & 0x0000FF00) >>> 0)/0x100;
            var alpha = ((terrain.color & 0x000000FF) >>> 0)/0x1;
            
            cache.region[Math.floor(i/regionProperties.height)][i % regionProperties.height] = {
              char: terrain.char,
              color: 'rgba(' + red + ',' + green + ',' + blue + ',' + alpha + ')'
            }
            
            if(bytes[1 + 13*i + 8]) {
              cache.region[Math.floor(i/regionProperties.height)][i % regionProperties.height].agentID = bytes.readUInt32LE(1 + 13*i + 9)
            }
          }
          
          cache.regionInitialized = true;
          
          if(cache.agentsInitialized) {
            drawRegion();
          }
          
          break;
        case 2: // Cell update
          var x = bytes.readUInt16LE(1);
          var y = bytes.readUInt16LE(3);
          
          var terrain = Particles.terrainLibrary[bytes.readUInt32LE(5)];
          
          var red   = ((terrain.color & 0xFF000000) >>> 0)/0x1000000;
          var green = ((terrain.color & 0x00FF0000) >>> 0)/0x10000;
          var blue  = ((terrain.color & 0x0000FF00) >>> 0)/0x100;
          var alpha = ((terrain.color & 0x000000FF) >>> 0)/0x1;
          
          cache.region[x][y] = {
            char: terrain.char,
            color: 'rgba(' + red + ',' + green + ',' + blue + ',' + alpha + ')'
          }
          
          if(bytes[9]) {
            cache.region[x][y].agentID = bytes.readUInt32LE(10);
          }
          
          if(cache.agentsInitialized && cache.regionInitialized) {
            drawCell(x, y, cache.region[x][y]);
          }
          
          break;
      }
    }
    
    fileReader.readAsArrayBuffer(e.data);
  }
  
  if(e.data.constructor.name === 'String') {
    regionProperties = JSON.parse(e.data);
  }
}

var wstest = new PersistentWS({url: window.location.protocol.replace('http', 'ws') + '//' + window.location.host});

wstest.addEventListener('message', wsMessageHandler);
wstest.addEventListener('open', function() {
  wstest.socket.send(JSON.stringify({req: 'region-properties'}))
  wstest.socket.send(JSON.stringify({req: 'region-agents'}));
  wstest.socket.send(JSON.stringify({req: 'region'}))
});

/////////////////////
// Startup scripts //
/////////////////////

eval(localStorage.onstart);

</script>
</html>
